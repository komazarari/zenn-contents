---
title: "Perforce Helix Core に Azure AD SSO でサインインする"
emoji: "📘"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Perforce", "Security", "SSO", "AzureAD", "SAML"]
published: false
---

## 出てくるサービス
- Perforce Helix Core (Core サーバ, p4d)
- Helix Authentication Service (HAS)
- Azure AD

## 作るもの
![architecture_diagram](https://storage.googleapis.com/zenn-user-upload/931cf233bebd-20221013.png)
- AWS 環境に HAS, p4d を起動する
- HAS の HTTPS 通信のために ALB を配置する
- HAS と Azure AD を連携させる
- ※ 図上は HAS と p4d を別インスタンスで書いているが、同一インスタンスでも問題ない

## 準備
- Azure AD の利用環境
- Helix Core サーバ(p4d)は動いているものとする
- HAS のドメインを決める
  - ここでは https://my-has-svc.example.com を使うものとする. 以降読み替えてください

## Azure AD 側の設定
### ギャラリーからのアプリ追加
[公式チュートリアルの "ギャラリーからの Perforce Helix Core - Helix Authentication Service の追加"](https://learn.microsoft.com/ja-jp/azure/active-directory/saas-apps/perforce-helix-core-tutorial#add-perforce-helix-core---helix-authentication-service-from-the-gallery)部分のように、
ギャラリーから *Perforce Helix Core - Helix Authentication Service* を追加する.

SSO を利用するユーザを明示的に指定するよう構成するならば、*Users and groups* よりユーザにロールを割り当てる. サインインできるすべてのユーザで利用するならば、*Properties -> Assignment required?* を No にする. 

### SAML の設定
[公式チュートリアルの Azure AD SSO の構成](https://learn.microsoft.com/ja-jp/azure/active-directory/saas-apps/perforce-helix-core-tutorial#configure-azure-ad-sso) 部分をやる. 

具体的には、*Single sign-on -> SAML* より、以下のように入力する.

- Basic SAML Configuration
  - Identifier (Entity ID) : `https://my-has-svc.example.com/saml`
  - Reply URL (Assertion Consumer Service URL) : `https://my-has-svc.example.com/saml/sso`
  - Sign on URL : `https://my-has-svc.example.com/`

(ここ 画像)

*SAML Certificates* より、`App Federation Metadata Url` をコピーしておく.

## Helix Authentication Service のセットアップ
今回は Ubuntu 20.04 サーバ用のパッケージ版で進める.  https://www.perforce.com/manuals/p4sag/Content/P4SAG/install.linux.packages.install.html の手順どおり.

### HAS インストール

```
wget -qO - https://package.perforce.com/perforce.pubkey | sudo apt-key add -
echo 'deb http://package.perforce.com/apt/ubuntu focal release' | sudo tee /etc/apt/sources.list.d/perforce.list
sudo apt update
sudo apt install helix-auth-svc
```
これで `/opt/perforce/` 以下に HAS がインストールされる. Ubuntu の場合は systemd 管理下で起動される.


### HAS セットアップ
簡単のため、HAS 同梱のセットアップスクリプト (`bin/configure-auth-service.sh`) を使う.

```
/opt/perforce/helix-auth-svc/bin/configure-auth-service.sh --allow-root
```
ガイドにしたがって設定する. 今回の場合は、以下のようになる
- Enter the URL for this service: https://my-has-svc.example.com/
- Please choose which features ...: 1 Authentication
- Please choose which protocols ...: 2 SAML
- Enter the URL for SAML IdP metadata: Azure AD 設定でコピーした `App Federation Metadata Url`
- Enter the URL for SAML IdP SSO endpoint: (空白でよい)

実行例: https://gist.github.com/komazarari/b25ee8cd0bb959c3fab4373e853c0b42

このスクリプトによって設定ファイル `/opt/perforce/helix-auth-svc/.env` が生成される.


今回の構成では ALB で HTTPS 終端させる想定なので、ALB から HAS への通信は http:3000 で通るように一部設定を変更する.

```
echo 'PORT=3000' | sudo tee -a /opt/perforce/helix-auth-svc/.env
echo 'PROTOCOL=http' | sudo tee -a /opt/perforce/helix-auth-svc/.env
echo 'TRUST_PROXY=(ALB のレンジ, VPC のサブネットレンジでよい)' | sudo tee -a /opt/perforce/helix-auth-svc/.env
sudo systemctl restart helix-auth.service
```

### ALB -> HAS 疎通

- `https://my-has-svc.example.com/` が ALB に解決され、正しく証明書がプロビジョニングされている状態にする
- ALB 443 リスナーが HAS をセットアップしたインスタンスの 3000 ポートにトラフィックを流すようにする

AWS 的な内容のみなので詳細は割愛.

### HAS 動作確認

ここまでの内容で、HAS + Azure AD の連携がセットアップされていることを確認できる. 以下のようになれば OK

- ブラウザで `https://my-has-svc.example.com/` にアクセスし HAS の Welcome ページが表示されること
- Azure AD の SAML 設定ページで、Test のエラーが無いこと

## Helix Core のセットアップ



## 関連資料
- https://learn.microsoft.com/ja-jp/azure/active-directory/saas-apps/perforce-helix-core-tutorial
- 