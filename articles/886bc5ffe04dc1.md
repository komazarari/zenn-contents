---
title: "Perforce Helix Core ã« Azure AD SSO ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹"
emoji: "ğŸ“˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Perforce", "Security", "SSO", "AzureAD", "SAML"]
published: false
---

## å‡ºã¦ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹
- Perforce Helix Core (Core ã‚µãƒ¼ãƒ, p4d)
- Helix Authentication Service (HAS)
- Azure AD

## ä½œã‚‹ã‚‚ã®
![architecture_diagram](https://storage.googleapis.com/zenn-user-upload/931cf233bebd-20221013.png)
- AWS ç’°å¢ƒã« HAS, p4d ã‚’èµ·å‹•ã™ã‚‹ â€»1
- HAS ã® HTTPS é€šä¿¡ã®ãŸã‚ã« ALB ã‚’é…ç½®ã™ã‚‹
- HAS ã¨ Azure AD ã‚’é€£æºã•ã›ã‚‹
- p4d ã« authentication-extension ã‚’å°å…¥ã™ã‚‹

â€»1 å›³ä¸Šã¯ HAS ã¨ p4d ã‚’åˆ¥ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§æ›¸ã„ã¦ã„ã‚‹ãŒã€åŒä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚‚å•é¡Œãªã„

## æº–å‚™
- Azure AD ã®åˆ©ç”¨ç’°å¢ƒ
- Helix Core ã‚µãƒ¼ãƒ(p4d)ã¯å‹•ã„ã¦ã„ã‚‹ã‚‚ã®ã¨ã™ã‚‹
- HAS ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ±ºã‚ã‚‹
  - ã“ã“ã§ã¯ https://my-has-svc.example.com ã‚’ä½¿ã†ã‚‚ã®ã¨ã™ã‚‹ã€‚ä»¥é™èª­ã¿æ›¿ãˆã¦ãã ã•ã„

## Azure AD å´ã®è¨­å®š
### ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰ã®ã‚¢ãƒ—ãƒªè¿½åŠ 
[å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã® "ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰ã® Perforce Helix Core - Helix Authentication Service ã®è¿½åŠ "](https://learn.microsoft.com/ja-jp/azure/active-directory/saas-apps/perforce-helix-core-tutorial#add-perforce-helix-core---helix-authentication-service-from-the-gallery) ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰ *Perforce Helix Core - Helix Authentication Service* ã‚’è¿½åŠ ã™ã‚‹ã€‚

SSO ã‚’åˆ©ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ã‚’æ˜ç¤ºçš„ã« Azure AD å´ã§æŒ‡å®šã—ãŸã„ãªã‚‰ã°ã€*Users and groups* ã‚ˆã‚Šãƒ¦ãƒ¼ã‚¶ã«ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã€‚ã‚‚ã—ãã¯ Azure AD ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ãã‚‹ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ã§ SSO ã‚’åˆ©ç”¨ã™ã‚‹ãªã‚‰ã°ã€*Properties -> Assignment required?* ã‚’ No ã«ã™ã‚‹ã€‚

### SAML ã®è¨­å®š
[å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã® Azure AD SSO ã®æ§‹æˆ](https://learn.microsoft.com/ja-jp/azure/active-directory/saas-apps/perforce-helix-core-tutorial#configure-azure-ad-sso) éƒ¨åˆ†ã‚’ã‚„ã‚‹ã€‚

å…·ä½“çš„ã«ã¯ã€*Single sign-on -> SAML* ã‚ˆã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ã«å…¥åŠ›ã™ã‚‹ã€‚

- Basic SAML Configuration
  - Identifier (Entity ID) : `https://my-has-svc.example.com/saml`
  - Reply URL (Assertion Consumer Service URL) : `https://my-has-svc.example.com/saml/sso`
  - Sign on URL : `https://my-has-svc.example.com/`
- SAML Certificates
  - `App Federation Metadata Url` ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãŠãã€‚

![](https://storage.googleapis.com/zenn-user-upload/c0b410bb8458-20221013.png)

## Helix Authentication Service ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
ä»Šå›ã¯ Ubuntu 20.04 ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç‰ˆã§é€²ã‚ã‚‹ã€‚ https://www.perforce.com/manuals/p4sag/Content/P4SAG/install.linux.packages.install.html ã«å¾“ã£ã¦é€²ã‚ã‚‹ã€‚

### HAS ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
wget -qO - https://package.perforce.com/perforce.pubkey | sudo apt-key add -
echo 'deb http://package.perforce.com/apt/ubuntu focal release' | sudo tee /etc/apt/sources.list.d/perforce.list
sudo apt-get update
sudo apt-get install helix-auth-svc
```
ã“ã‚Œã§ `/opt/perforce/` ä»¥ä¸‹ã« HAS ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã€‚ã“ã® Ubuntu ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç‰ˆã®å ´åˆã¯ systemd ç®¡ç†ä¸‹ã§èµ·å‹•ã•ã‚Œã‚‹ã€‚


### HAS ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
ç°¡å˜ã®ãŸã‚ã€HAS åŒæ¢±ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (`bin/configure-auth-service.sh`) ã‚’ä½¿ã†ã€‚

```
sudo -E /opt/perforce/helix-auth-svc/bin/configure-auth-service.sh --allow-root
```
ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¬ã‚¤ãƒ‰ã«ã—ãŸãŒã£ã¦è¨­å®šã™ã‚‹ã€‚ä»Šå›ã®å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚å®Ÿè¡Œä¾‹ã‚‚å‚ç…§
- Enter the URL for this service: https://my-has-svc.example.com/
- Please choose which features ...: 1 Authentication
- Please choose which protocols ...: 2 SAML
- Enter the URL for SAML IdP metadata: Azure AD è¨­å®šã§ã‚³ãƒ”ãƒ¼ã—ãŸ `App Federation Metadata Url`
- Enter the URL for SAML IdP SSO endpoint: (ç©ºç™½ã§ã‚ˆã„)

å®Ÿè¡Œä¾‹: https://gist.github.com/komazarari/b25ee8cd0bb959c3fab4373e853c0b42

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã£ã¦è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« `/opt/perforce/helix-auth-svc/.env` ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚


ä»Šå›ã®æ§‹æˆã§ã¯ ALB ã§ HTTPS çµ‚ç«¯ã•ã›ã‚‹æƒ³å®šãªã®ã§ã€ALB ã‹ã‚‰ HAS ã¸ã®é€šä¿¡ã¯ http:3000 ã§é€šã‚‹ã‚ˆã†ã«ä¸€éƒ¨è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã€‚

```
echo 'PORT=3000' | sudo tee -a /opt/perforce/helix-auth-svc/.env
echo 'PROTOCOL=http' | sudo tee -a /opt/perforce/helix-auth-svc/.env
echo 'TRUST_PROXY=(ALB ã®ãƒ¬ãƒ³ã‚¸, VPC ã®ã‚µãƒ–ãƒãƒƒãƒˆãƒ¬ãƒ³ã‚¸ã§ã‚ˆã„)' | sudo tee -a /opt/perforce/helix-auth-svc/.env
sudo systemctl restart helix-auth.service
```

### ALB -> HAS ç–é€š

- `https://my-has-svc.example.com/` ãŒ ALB ã«è§£æ±ºã•ã‚Œã€æ­£ã—ãè¨¼æ˜æ›¸ãŒãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã«ã™ã‚‹
- ALB 443 ãƒªã‚¹ãƒŠãƒ¼ãŒ HAS ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã® 3000 ãƒãƒ¼ãƒˆã«ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æµã™ã‚ˆã†ã«ã™ã‚‹

AWS çš„ãªå†…å®¹ã®ã¿ãªã®ã§è©³ç´°ã¯å‰²æ„›ã€‚

### HAS å‹•ä½œç¢ºèª

ã“ã“ã¾ã§ã®å†…å®¹ã§ã€HAS + Azure AD ã®é€£æºãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Œã° OK

- ãƒ–ãƒ©ã‚¦ã‚¶ã§ `https://my-has-svc.example.com/` ã«ã‚¢ã‚¯ã‚»ã‚¹ã— HAS ã® Welcome ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
- Azure AD ã® SAML è¨­å®šãƒšãƒ¼ã‚¸ã§ã€Test ã®ã‚¨ãƒ©ãƒ¼ãŒç„¡ã„ã“ã¨

## Helix Core (p4d) ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
Helix Core ã‚µãƒ¼ãƒ (p4d) ãŒå‹•ã„ã¦ãŠã‚Šã€é©å½“ãªãƒ¦ãƒ¼ã‚¶ã€ã‚°ãƒ«ãƒ¼ãƒ—ãŒã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã¨ã™ã‚‹ã€‚

â€» Azure AD SSO ã‚’ä½¿ã†å ´åˆã§ã‚‚, p4d å´ã«ãƒ¦ãƒ¼ã‚¶, ã‚°ãƒ«ãƒ¼ãƒ—ãŒå¿…è¦
### helix-authentication-extension ã®ãƒ“ãƒ«ãƒ‰ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

https://github.com/perforce/helix-authentication-extension ã‚’ä½¿ã†ã€‚æœ€æ–°æƒ…å ±ã«ã¤ã„ã¦ã¯ docs ã‚’å‚ç…§ãã ã•ã„

```
git clone https://github.com/perforce/helix-authentication-extension
```

extension ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹
```
cd helix-authentication-extension
p4 extension --package loginhook
```
`loginhook.p4-extension` ã¨ã„ã† ZIP ãŒä½œæˆã•ã‚Œã‚‹ã€‚

Ubuntu ã® p4d ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã§ã¯ç½²åã®ãªã„ extension ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããªã„ã®ã§ã€ç½²åç„¡ã—ã§ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†è¨­å®šã‚’å¤‰æ›´ã—ãŸã†ãˆã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

```
p4 configure set server.extensions.allow.unsigned=1
p4 extension --install loginhook.p4-extension -y

(ç¢ºèª)
p4 extension --list --type=extensions
```

### helix-authentication-extension ã®è¨­å®š

ç¾åœ¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã‚’ãƒ€ãƒ³ãƒ—ã™ã‚‹
```
p4 extension --configure Auth::loginhook -o > /tmp/loginhook.conf.orig
```

ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã‚’æ›´æ–°ã™ã‚‹ã€‚æ›´æ–°å†…å®¹ã¯æ¬¡ã«ç¤ºã™ diff ã‚’å‚ç…§ã€‚
```
p4 extension --configure Auth::loginhook
p4 extension --configure Auth::loginhook -o > /tmp/loginhook.conf.updated
```

å¤‰æ›´å·®åˆ†ã¯ä»¥ä¸‹, Auth-Protocol ã¨ Service-URL ã‚’è¨­å®šã™ã‚‹ã€‚super ãƒ¦ãƒ¼ã‚¶ç­‰ã‚‚ç’°å¢ƒã«ã‚ã‚ã›è¨­å®šã™ã‚‹ã€‚
```diff
@@ -37,20 +37,20 @@

 ExtEnabled:     true

-ExtP4USER:     sampleExtensionsUser
+ExtP4USER:     super

 Name:   loginhook

 Owner:  super

-Update:        2022/**/** **:**:**
+Update:        2022/**/** **:**:**

 Description:
         The description of your config.

 ExtConfig:
         Auth-Protocol:
-                ... Authentication protocol, such as 'saml' or 'oidc'.
+               saml
         Authority-Cert:
                 ... Path to certificate authority public key, defaults to ./ca.crt
         Client-Cert:
@@ -58,7 +58,7 @@
         Client-Key:
                 ... Path to client private key, defaults to ./client.key
         Service-URL:
-                ... The authentication service base URL.
+               https://my-has-svc.example.com
         Verify-Host:
                 ... Ensure service host name matches certificate, if 'true'.
         Verify-Peer:
```

ç¶šã„ã¦ã€å€‹åˆ¥è¨­å®šã‚‚æ›´æ–°ã™ã‚‹ã€‚ä»Šå›ã“ã®è¨­å®šã¯ `loginhook-a1` ã¨ã„ã†åå‰ã«ã—ã¦ã„ã‚‹ã€‚ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®ã¨ãã¨åŒæ§˜ã«ç¾åœ¨ã®è¨­å®šã‚’ãƒ€ãƒ³ãƒ—ã™ã‚‹
```
p4 extension --configure Auth::loginhook --name loginhook-a1 -o > /tmp/loginhook-a1.conf.orig
```
`loginhook-a1` ã‚’æ›´æ–°ã™ã‚‹ã€‚æ›´æ–°å†…å®¹ã¯æ¬¡ã«ç¤ºã™ diff ã‚’å‚ç…§ã€‚
```
p4 extension --configure Auth::loginhook --name loginhook-a1
p4 extension --configure Auth::loginhook --name loginhook-a1 -o > /tmp/loginhook-a1.conf.updated
```


å¤‰æ›´å·®åˆ†ã¯ä»¥ä¸‹,
```diff
@@ -40,7 +40,7 @@

 Owner: super

-Update:        2022/**/** **:**:**
+Update:        2022/**/** **:**:**

 Description:
        The description of your config.
@@ -55,17 +55,17 @@
        client-user-identifier:
                ... Trigger variable used as unique P4LOGINSSO user identifier.
        enable-logging:
-               ... Extension will write debug messages to a log if 'true'.
+               true
        name-identifier:
-               ... Field within IdP response containing unique user identifier.
+               nameID
        non-sso-groups:
-               ... Those groups whose members will not be using SSO.
+               admins
        non-sso-users:
-               ... Those users who will not be using SSO.
+               super
        sso-groups:
-               ... Those groups whose members must authenticate using SSO.
+               your-sso-group-1 (SSO ã‚’åˆ©ç”¨ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’åˆ—æŒ™)
+               your-sso-group-2
        sso-users:
-               ... Those users who must authenticate using SSO.
+               some-sso-user-1 (SSO ã‚’åˆ©ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ã‚’åˆ—æŒ™)
+               some-sso-user-2
        user-identifier:
-               ... Trigger variable used as unique user identifier.
+               email

```

æ­£ã—ãè¨­å®šã§ãã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã« list ã§ `auth-check-sso`, `auth-pre-sso` ç­‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```
p4 extension --list --type configs
... config loginhook
... extension Auth::loginhook
... uuid 117E9283-732B-45A6-9993-AE64C354F1C5
... revision 1
... owner super
... type global-extcfg

... config loginhook-a1
... extension Auth::loginhook
... uuid 117E9283-732B-45A6-9993-AE64C354F1C5
... revision 1
... owner super
... type auth-check-sso
... arg auth
... debugStatus none

... config loginhook-a1
... extension Auth::loginhook
... uuid 117E9283-732B-45A6-9993-AE64C354F1C5
... revision 1
... owner super
... type auth-pre-sso
... arg auth
... debugStatus none

... config loginhook-a1
... extension Auth::loginhook
... uuid 117E9283-732B-45A6-9993-AE64C354F1C5
... revision 1
... owner super
... type extension-run
... arg unset
... debugStatus none
```

p4d ã‚’å†èµ·å‹•ã—ã¦å®Œäº†ã€‚
```
# Ubuntu (systemd) ã®å ´åˆ
sudo systemctl restart helix-p4dctl.service
```

## æ¥ç¶šç¢ºèª

p4v ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ Helix Core ã‚µãƒ¼ãƒ(p4d) ã«æ¥ç¶šã™ã‚‹ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã§ãªããƒ–ãƒ©ã‚¦ã‚¶ã§ Azure AD ãƒšãƒ¼ã‚¸ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒè¡Œã‚ã‚Œã¦ã€HAS ã§ Login Successful ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
![SS Login Sccessful](https://storage.googleapis.com/zenn-user-upload/9387d06e3111-20221013.png)


Azure AD ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã—ã¦ã„ã‚‹ã«ã‚‚é–¢ã‚ã‚‰ãš HAS ã® Login Succressful ã§ã¯ãªãé€šå¸¸ãƒˆãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã†å ´åˆ, TRUST_PROXY è¨­å®šãŒèª¤ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
https://www.perforce.com/manuals/helix-auth-svc/Content/HAS/troubleshooting.html ã® *Chrome does not allow login* ã¨åŒæ ¹ã®å•é¡Œãªã®ã§ IP ãƒ¬ãƒ³ã‚¸ã‚’ç¢ºèªã€‚


## é–¢é€£è³‡æ–™
- https://learn.microsoft.com/ja-jp/azure/active-directory/saas-apps/perforce-helix-core-tutorial
- https://www.perforce.com/manuals/helix-auth-svc/Content/HAS/Home-has.html
- https://github.com/perforce/helix-authentication-extension/blob/master/docs/Administrator-Guide-2022.1.md#manual-installation
- https://github.com/p4misc/p4memo/blob/master/helix-authentication-service.md
